<!-- Sınıfların Genel Durumu -->
<div class="h-full max-h-full p-4 lg:p-6 overflow-hidden relative">
  <!-- Kapat Butonu -->
  <div class="absolute top-4 right-4 z-10">
    <button class="btn btn-ghost p-2" (click)="appState.collapseAll()" aria-label="Kapat">
      <span class="text-lg font-bold text-espresso">✕</span>
    </button>
  </div>
  
  <div class="hidden md:grid gap-3 lg:grid-cols-2 xl:grid-cols-3 h-full" style="grid-template-columns: 1fr 1.15fr 1.15fr;">
    <!-- Sol: Sınıf Listesi -->
    <section class="flexible-content overflow-hidden">
      <div class="mt-0 flex items-center justify-between">
        <h4 class="text-lg font-semibold text-espresso">Sınıf Listesi</h4>
      </div>
      <!-- Sorting header (single button like other lists) -->
      <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0 mt-1">
        <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg rounded-tr-lg" (click)="classSummaryService.sortClasses()" [ngClass]="{'bg-primary/10': true}">
          <span class="flex items-center gap-1">
            Sınıf
            <span class="text-primary">{{ classSummaryService.classSortOrder() === 'asc' ? '↑' : '↓' }}</span>
          </span>
        </button>
      </div>
      <div class="h-[343px] overflow-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
        <button 
          *ngFor="let className of classSummaryService.sortedClasses(); index as i" 
          class="group w-full text-left h-14 px-3 relative" 
          [ngClass]="{'bg-infoSurface/30': classSummaryService.selectedClass()===className}" 
          (click)="classSummaryService.chooseClass(className)">
          <div class="flex items-center justify-between h-full">
            <div class="text-[17px] font-semibold text-espresso">{{ className }}</div>
            <div *ngIf="classSummaryService.selectedClass()===className" class="text-primary">✔</div>
          </div>
        </button>
      </div>
    </section>
    
    <!-- Orta: Ders Listesi -->
    <section class="flexible-content hidden lg:block" [class.animate-slide-in]="classSummaryService.selectedClass()">
      <div *ngIf="!classSummaryService.selectedClass()" class="mt-7 h-96 border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="classSummaryService.selectedClass()">
        <div class="text-base font-semibold text-espresso">{{ classSummaryService.selectedClass() }} · Sınav Listesi</div>
        <!-- Sorting header for subject list (subject + date) -->
        <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0 mt-2">
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg" (click)="classSummaryService.sortClassExamsBy('subject')" [ngClass]="{'bg-primary/10': classSummaryService.classExamSortBy() === 'subject'}">
            <span class="flex items-center gap-1">
              Sınav
              <span *ngIf="classSummaryService.classExamSortBy() === 'subject'" class="text-primary">{{ classSummaryService.classExamSortOrder() === 'asc' ? '↑' : '↓' }}</span>
            </span>
          </button>
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors border-l border-borderGray rounded-tr-lg" (click)="classSummaryService.sortClassExamsBy('date')" [ngClass]="{'bg-primary/10': classSummaryService.classExamSortBy() === 'date'}">
            <span class="flex items-center gap-1">
              Tarih
              <span *ngIf="classSummaryService.classExamSortBy() === 'date'" class="text-primary">{{ classSummaryService.classExamSortOrder() === 'asc' ? '↑' : '↓' }}</span>
            </span>
          </button>
        </div>
        <div class="h-[342px] overflow-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
          <button 
            *ngFor="let exam of classSummaryService.currentClassExams()" 
            class="w-full text-left h-12 px-3 relative hover:bg-primary/10" 
            (click)="classSummaryService.chooseSubject(exam.subject)" 
            [ngClass]="{'bg-infoSurface/30': classSummaryService.selectedSubject()===exam.subject}">
            <div class="flex items-center justify-between h-full">
              <div class="text-[15px] font-semibold text-espresso">{{ exam.subject }}</div>
              <div class="text-sm text-espresso/70">{{ exam.date }}</div>
              <div *ngIf="classSummaryService.selectedSubject()===exam.subject" class="text-primary">✔</div>
            </div>
          </button>
        </div>
      </div>
    </section>
    
    <!-- Sağ: İstatistikler -->
    <section class="flexible-content hidden xl:block" [class.animate-slide-in]="classSummaryService.selectedSubject()">
      <div *ngIf="!classSummaryService.selectedSubject()" class="mt-7 h-96 border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="classSummaryService.selectedSubject()" class="relative mt-8">
        <!-- Başlık - Kenarlığın üzerinde -->
        <div class="absolute -top-9 left-4 z-10 bg-white px-3 py-1">
          <div class="text-base font-semibold text-espresso">{{ classSummaryService.selectedClass() }} · {{ classSummaryService.selectedSubject() }} Sınav Analizi</div>
        </div>

        <!-- Ana kart -->
        <div class="h-[380px] overflow-auto rounded-lg border border-borderGray bg-white">
          <!-- Sınıf İstatistikleri -->
          <div class="px-3 pt-6 pb-3" *ngIf="classSummaryService.classStats()">
            <div class="grid sm:grid-cols-2 gap-4 items-center">
              <div>
                <div class="text-xs text-espresso/60 mb-1">Sınıf Ortalaması</div>
                <div class="text-2xl font-semibold text-espresso">{{ classSummaryService.classStats()?.avg }} / 100</div>
                <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full overflow-hidden">
                  <div class="h-full bg-primary" [style.width.%]="classSummaryService.classStats()?.avg || 0"></div>
                </div>
              </div>
              <div>
                <div class="text-xs text-espresso/60 mb-1">Kopya İhtimali</div>
                <div class="text-xl font-semibold text-espresso">%{{ classSummaryService.classStats()?.copyProb }}</div>
                <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full overflow-hidden">
                  <div class="h-full rounded-full"
                       [ngStyle]="{
                         width: ((classSummaryService.classStats()?.copyProb || 0) + '%'),
                         background: (classSummaryService.classStats()?.copyProb||0) < 15 ? '#22c55e' :
                                    (classSummaryService.classStats()?.copyProb||0) < 40 ? '#eab308' : '#ef4444'
                       }"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Puan Aralığı Grafiği -->
          <div class="card p-2" *ngIf="classSummaryService.classStats()">
            <div class="text-sm font-medium text-espresso mb-2">Sınav Puan Aralığı</div>
            <div class="flex items-center gap-4">
              <div class="relative" style="width: 84px; height: 84px;">
                <div class="rounded-full" style="width: 84px; height: 84px; background: #e5e7eb;">
                  <div class="rounded-full" [ngStyle]="{ background: classSummaryService.donutGradient(), width: '84px', height: '84px' }"></div>
                </div>
                <div class="absolute inset-0 grid place-items-center">
                  <div class="bg-white rounded-full" style="width: 48px; height: 48px;"></div>
                </div>
              </div>
              <div class="text-sm space-y-1">
                <div *ngFor="let seg of classSummaryService.rangesChartSegments()" class="flex items-center gap-2">
                  <span class="inline-block w-3 h-3 rounded" [style.background]="seg.color"></span>
                  <span>{{ seg.label }} — {{ seg.count }} kişi</span>
                </div>
              </div>
            </div>
            <!-- Ek küçük istatistikler: daire grafiğinin altında -->
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div class="bg-slate-50 p-2 rounded-lg">
                <div class="text-xs font-semibold text-espresso">Sınıf Not Ortalaması</div>
                <div class="text-mono text-base">78</div>
              </div>
              <div class="bg-slate-50 p-2 rounded-lg">
                <div class="text-xs font-semibold text-espresso">En Yüksek Not</div>
                <div class="text-mono text-base">94</div>
              </div>
              <div class="bg-slate-50 p-2 rounded-lg">
                <div class="text-xs font-semibold text-espresso">En Düşük Not</div>
                <div class="text-mono text-base">52</div>
              </div>
              <div class="bg-slate-50 p-2 rounded-lg">
                <div class="text-xs font-semibold text-espresso">Soru Sayısı</div>
                <div class="text-mono text-base">12</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- lg: Analysis below -->
    <section class="lg:col-span-2 xl:hidden" [class.hidden]="!classSummaryService.selectedSubject()">
      <div *ngIf="classSummaryService.selectedSubject()" class="animate-slide-in space-y-2">
        <div class="text-base font-semibold text-espresso">{{ classSummaryService.selectedClass() }} · {{ classSummaryService.selectedSubject() }}</div>
        
        <!-- Tekrarlanan İstatistik Kartları lg layout için -->
        <div class="card p-2" *ngIf="classSummaryService.classStats()">
          <div class="grid sm:grid-cols-2 gap-4 items-center">
            <div>
              <div class="text-xs text-espresso/60 mb-1">Sınıf Ortalaması</div>
              <div class="text-3xl font-semibold text-espresso">{{ classSummaryService.classStats()?.avg }} / 100</div>
              <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full overflow-hidden">
                <div class="h-full bg-primary" [style.width.%]="classSummaryService.classStats()?.avg || 0"></div>
              </div>
            </div>
            <div>
              <div class="text-xs text-espresso/60 mb-1">Kopya İhtimali</div>
              <div class="text-2xl font-semibold text-espresso">%{{ classSummaryService.classStats()?.copyProb }}</div>
              <div class="mt-2 h-3 w-full bg-borderGray/50 rounded-full overflow-hidden">
                <div class="h-full rounded-full" 
                     [ngStyle]="{ 
                       width: ((classSummaryService.classStats()?.copyProb || 0) + '%'), 
                       background: (classSummaryService.classStats()?.copyProb||0) < 15 ? '#22c55e' : 
                                  (classSummaryService.classStats()?.copyProb||0) < 40 ? '#eab308' : '#ef4444' 
                     }"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card p-2" *ngIf="classSummaryService.classStats()">
          <div class="text-sm font-medium text-espresso mb-2">Sınav Puan Aralığı</div>
          <div class="flex items-center gap-4">
            <div class="relative" style="width: 84px; height: 84px;">
              <div class="rounded-full" style="width: 84px; height: 84px; background: #e5e7eb;">
                <div class="rounded-full" [ngStyle]="{ background: classSummaryService.donutGradient(), width: '84px', height: '84px' }"></div>
              </div>
              <div class="absolute inset-0 grid place-items-center">
                <div class="bg-white rounded-full" style="width: 48px; height: 48px;"></div>
              </div>
            </div>
            <div class="text-sm space-y-1">
              <div *ngFor="let seg of classSummaryService.rangesChartSegments()" class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded" [style.background]="seg.color"></span>
                <span>{{ seg.label }} — {{ seg.count }} kişi</span>
              </div>
            </div>
          </div>
          <!-- Ek küçük istatistikler: daire grafiğinin altında (lg layout) -->
          <div class="mt-3 grid grid-cols-2 gap-2">
            <div class="bg-slate-50 p-2 rounded-lg">
              <div class="text-xs font-semibold text-espresso">Sınıf Not Ortalaması</div>
              <div class="text-mono text-base">78</div>
            </div>
            <div class="bg-slate-50 p-2 rounded-lg">
              <div class="text-xs font-semibold text-espresso">En Yüksek Not</div>
              <div class="text-mono text-base">94</div>
            </div>
            <div class="bg-slate-50 p-2 rounded-lg">
              <div class="text-xs font-semibold text-espresso">En Düşük Not</div>
              <div class="text-mono text-base">52</div>
            </div>
            <div class="bg-slate-50 p-2 rounded-lg">
              <div class="text-xs font-semibold text-espresso">Soru Sayısı</div>
              <div class="text-mono text-base">12</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

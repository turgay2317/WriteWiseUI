<!-- Student List Component Template -->
<div class="h-full max-h-full overflow-hidden p-4 lg:p-6 pt-0 lg:pt-0 flex flex-col">
  <!-- Kapat Butonu -->
  <div class="flex justify-end mb-1 flex-shrink-0">
    <button class="btn btn-ghost p-2" (click)="appState.collapseAll()" aria-label="Kapat">
      <span class="text-lg font-bold text-espresso">✕</span>
    </button>
  </div>

  <!-- Web Layout: 3 cols, Lg: 2 cols with analysis below -->
  <div class="flex flex-col flex-1 h-full">
    <div class="grid gap-4 lg:grid-cols-2 xl:grid-cols-3 flex-1" style="grid-template-columns: 1fr 1.15fr 1.15fr;">
    <!-- Left: Student List -->
    <section class="flexible-content min-w-0 h-full flex flex-col -mt-4 lg:-mt-5">
      <div class="flex items-center justify-between mb-2  flex-shrink-0 px-1">
        <h4 class="text-base font-semibold text-espresso">Öğrenci Listesi</h4>
        <div class="ml-3 py-1">
          <input 
            type="search" 
            [value]="studentService.query()" 
            (input)="studentService.setQuery($any($event.target).value)" 
            placeholder="Ad / No ara…" 
            class="w-32 sm:w-40 md:w-48 rounded-md border border-borderGray bg-white px-3 py-2 text-sm placeholder:text-espresso/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-espresso"/>
        </div>
      </div>

      <!-- Sorting Header - Outside the scrollable area (same layout as exam list) -->
      <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0">
        <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg" (click)="studentService.sortStudentsBy('name')" [ngClass]="{'bg-primary/10': studentService.studentSortBy() === 'name'}">
          <span class="flex items-center gap-1">
            Ad
            <span *ngIf="studentService.studentSortBy() === 'name'" class="text-primary">
              {{ studentService.studentSortOrder() === 'asc' ? '↑' : '↓' }}
            </span>
          </span>
        </button>
        <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors border-l border-borderGray rounded-tr-lg" (click)="studentService.sortStudentsBy('className')" [ngClass]="{'bg-primary/10': studentService.studentSortBy() === 'className'}">
          <span class="flex items-center gap-1">
            Sınıf
            <span *ngIf="studentService.studentSortBy() === 'className'" class="text-primary">
              {{ studentService.studentSortOrder() === 'asc' ? '↑' : '↓' }}
            </span>
          </span>
        </button>
      </div>
      
      <div class="h-[344px] overflow-y-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
        <div *ngIf="studentService.filteredStudents().length===0" class="h-14 grid place-items-center text-espresso/60">
          Liste boş
        </div>
        
        <button 
          *ngFor="let student of studentService.filteredStudents(); index as i" 
          class="group w-full text-left h-14 px-3 relative" 
          [ngClass]="{'bg-infoSurface/30': studentService.selectedStudent()?.id===student.id}" 
          (mouseenter)="studentService.focusStudentIdx.set(i)" 
          (click)="studentService.selectStudent(student)">
          
          <div class="absolute left-0 top-0 h-full w-1" 
               [style.background]="studentService.focusStudentIdx()===i ? '#ea940c' : 'transparent'">
          </div>
          
          <div class="flex items-center justify-between h-full">
            <div class="flex-1 min-w-0">
              <div class="text-[17px] font-semibold text-espresso">{{ student.name }}</div>
              <div class="text-sm text-espresso/60">{{ student.className }} Sınıfı · No: {{ student.numara }}</div>
            </div>
            <div *ngIf="studentService.selectedStudent()?.id===student.id" class="text-primary">✔</div>
          </div>
        </button>
      </div>
    </section>

    <!-- Middle: Exam List -->
    <section class="flexible-content hidden lg:block h-full flex flex-col" [class.animate-slide-in]="studentService.selectedStudent()">
      <div *ngIf="!studentService.selectedStudent()" class="h-[395px] border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="studentService.selectedStudent()" class="flex-1 h-full flex flex-col">
        <div class="flex items-center justify-between mb-2 flex-shrink-0">
          <div class="text-base font-semibold text-espresso whitespace-nowrap min-h-0 text-ellipsis">{{ studentService.selectedStudent()?.name }} · Sınav Listesi</div>
        </div>
        
        <!-- Sorting Header - Outside the scrollable area -->
        <div class="flex bg-gray-50 text-sm font-medium text-espresso/70 border border-borderGray rounded-t-lg mb-0">
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors rounded-tl-lg" (click)="studentService.sortExamsBy('subject')" [ngClass]="{'bg-primary/10': studentService.examSortBy() === 'subject'}">
            <span class="flex items-center gap-1">
            Sınav
              <span *ngIf="studentService.examSortBy() === 'subject'" class="text-primary">
                {{ studentService.examSortOrder() === 'asc' ? '↑' : '↓' }}
              </span>
            </span>
          </button>
          <button class="flex-1 px-3 py-2 text-left hover:bg-gray-100 transition-colors border-l border-borderGray rounded-tr-lg" (click)="studentService.sortExamsBy('date')" [ngClass]="{'bg-primary/10': studentService.examSortBy() === 'date'}">
            <span class="flex items-center gap-1">
              Tarih
              <span *ngIf="studentService.examSortBy() === 'date'" class="text-primary">
                {{ studentService.examSortOrder() === 'asc' ? '↑' : '↓' }}
              </span>
            </span>
          </button>
        </div>
        
        <!-- Exam List Content - Only the scrollable part -->
        <div class="h-[325px] overflow-y-auto divide-y divide-borderGray/60 border-l border-r border-b border-borderGray rounded-b-lg">
          <div *ngIf="studentService.sortedExams().length===0" class="h-12 grid place-items-center text-espresso/60">Sınav yok</div>
          <button 
            *ngFor="let exam of studentService.sortedExams(); index as i" 
            class="w-full text-left h-14 px-3 hover:bg-primary/10" 
            (mouseenter)="studentService.focusExamIdx.set(i)" 
            (click)="studentService.selectExam(exam); loadExamQuestions()">
            <div class="flex items-center justify-between h-full">
              <div class="flex-1 min-w-0">
                <div class="text-[16px] font-medium text-espresso">{{ exam.subject }}</div>
                <div class="text-sm text-espresso/70">{{ formatTurkishDate(exam.date) }}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-medium text-espresso">{{ exam.score }}</div>
                <div class="text-xs text-espresso/60" [ngClass]="{
                  'text-green-600': (exam.copyProb || 0) < 15,
                  'text-yellow-600': (exam.copyProb || 0) >= 15 && (exam.copyProb || 0) < 40,
                  'text-red-600': (exam.copyProb || 0) >= 40
                }">%{{ exam.copyProb }}</div>
              </div>
            </div>
          </button>
        </div>
      </div>
    </section>

    <!-- Right: Exam Analysis (xl) -->
    <section class="flexible-content hidden xl:block h-full flex flex-col" [class.animate-slide-in]="studentService.selectedExam()">
      <div *ngIf="!studentService.selectedExam()" class="h-[395px]  border-2 border-dashed border-borderGray rounded-lg grid place-items-center text-espresso/50">Seçim yapın</div>
      <div *ngIf="studentService.selectedExam()" class="flex-1 flex flex-col">
        <div class="text-base font-semibold text-espresso mb-2">Sınav Analizi — {{ studentService.selectedExam()?.subject }} {{ studentService.selectedExam()?.date }}</div>
        <div class="h-[360px] overflow-y-auto rounded-lg border border-borderGray">
          <div class="space-y-4 p-4">

            <!-- Öğrenci Sınav Sonucu -->
            <div class="bg-white border border-borderGray rounded-lg p-4">
              <h4 class="text-sm font-semibold text-espresso mb-3">Öğrenci Sınav Sonucu</h4>
              
              <!-- Puan Özeti -->
              <div class="flex items-center justify-between mb-4 p-3 bg-blue-50 rounded-lg">
                <div>
                  <div class="text-lg font-semibold text-espresso">{{ studentService.selectedExam()?.score }}</div>
                  <div class="text-sm text-espresso/60">Toplam Puan</div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-espresso">{{ studentService.selectedExam()?.totalQuestions }} soru</div>
                  <div class="text-xs text-espresso/60">Sınav</div>
                </div>
              </div>

              <!-- Sınav Detayları -->
              <div class="space-y-3 mb-4">
                <div class="text-sm text-espresso/60">
                  <strong>Ders:</strong> {{ studentService.selectedExam()?.subject }}
                </div>
                <div class="text-sm text-espresso/60">
                  <strong>Tarih:</strong> {{ formatTurkishDate(studentService.selectedExam()?.date || '') }}
                </div>
                <div class="text-sm text-espresso/60">
                  <strong>Sınav Türü:</strong> {{ studentService.selectedExam()?.type }}
                </div>
              </div>

              <!-- Detaylı Soru Analizi -->
              <div class="mt-4">
                <h5 class="text-sm font-semibold text-espresso mb-3">Soru Analizleri</h5>
                <div class="space-y-4 max-h-64 overflow-y-auto">
                  <div *ngFor="let question of getExamQuestions(); let i = index" class="border border-borderGray rounded-lg p-4 bg-gray-50">
                    <!-- Soru Başlığı ve Puan -->
                    <div class="flex justify-between items-center mb-3">
                      <div class="text-base font-semibold text-espresso">Soru {{ question.soru_no }}</div>
                      <div class="text-sm font-medium" [ngClass]="{
                        'text-green-600': question.cevap.cevap_puan > 0,
                        'text-red-600': question.cevap.cevap_puan === 0
                      }">
                        {{ question.cevap.cevap_puan }}/{{ question.soru_puan }} puan
                      </div>
                    </div>
                    
                    <!-- Soru Metni -->
                    <div class="text-sm text-espresso mb-3 p-2 bg-white rounded border-l-4 border-blue-500">
                      <strong>Soru:</strong> {{ question.soru_metni }}
                    </div>
                    
                    <!-- Öğrenci Cevabı -->
                    <div class="text-sm text-espresso/80 mb-3 p-2 bg-white rounded">
                      <strong>Öğrenci Cevabı:</strong> 
                      <span class="ml-2 font-medium">{{ question.cevap.cevap_metni || 'Cevap verilmemiş' }}</span>
                    </div>
                    
                    <!-- Analiz Bölümü -->
                    <div class="space-y-2">
                      <!-- Pozitif Analiz -->
                      <div *ngIf="question.analiz.pozitif && question.analiz.pozitif.trim()" 
                           class="text-xs text-green-800 bg-green-100 p-3 rounded-lg border border-green-200">
                        <div class="flex items-start">
                          <span class="text-green-600 mr-2">✓</span>
                          <div>
                            <strong class="text-green-700">Pozitif Değerlendirme:</strong>
                            <div class="mt-1">{{ question.analiz.pozitif }}</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Negatif Analiz -->
                      <div *ngIf="question.analiz.negatif && question.analiz.negatif.trim()" 
                           class="text-xs text-red-800 bg-red-100 p-3 rounded-lg border border-red-200">
                        <div class="flex items-start">
                          <span class="text-red-600 mr-2">⚠</span>
                          <div>
                            <strong class="text-red-700">Geliştirilmesi Gerekenler:</strong>
                            <div class="mt-1">{{ question.analiz.negatif }}</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Analiz Yoksa -->
                      <div *ngIf="!question.analiz.pozitif && !question.analiz.negatif" 
                           class="text-xs text-gray-600 bg-gray-100 p-3 rounded-lg">
                        <div class="flex items-center">
                          <span class="text-gray-500 mr-2">ℹ</span>
                          <span>Bu soru için detaylı analiz bulunmuyor.</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Soru Yoksa -->
                  <div *ngIf="getExamQuestions().length === 0" 
                       class="text-center text-gray-500 py-8">
                    <div class="text-sm">Bu sınav için soru detayları bulunamadı.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- On lg (2 cols), analysis below -->
    <section class="lg:col-span-2 xl:hidden flex flex-col" [class.hidden]="!studentService.selectedExam()">
      <div *ngIf="studentService.selectedExam()" class="animate-slide-in flex flex-col">
        <div class="text-base font-semibold text-espresso mb-2">Sınav Analizi — {{ studentService.selectedExam()?.subject }} {{ studentService.selectedExam()?.date }}</div>
        <div class="h-[350px] overflow-y-auto rounded-lg border border-borderGray">
          <div class="space-y-4 p-4">

            <!-- Öğrenci Sınav Sonucu -->
            <div class="bg-white border border-borderGray rounded-lg p-4">
              <h4 class="text-sm font-semibold text-espresso mb-3">Öğrenci Sınav Sonucu</h4>
              
              <!-- Puan Özeti -->
              <div class="flex items-center justify-between mb-4 p-3 bg-blue-50 rounded-lg">
                <div>
                  <div class="text-lg font-semibold text-espresso">{{ studentService.selectedExam()?.score }}</div>
                  <div class="text-sm text-espresso/60">Toplam Puan</div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-espresso">{{ studentService.selectedExam()?.totalQuestions }} soru</div>
                  <div class="text-xs text-espresso/60">Sınav</div>
                </div>
              </div>

              <!-- Kopya Analizi -->
              <div *ngIf="studentService.selectedExam()?.copyText" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <div class="text-xs text-red-600 font-medium mb-2">⚠️ Kopya Analizi</div>
                <div class="text-sm text-red-700 whitespace-pre-line">{{ studentService.selectedExam()?.copyText }}</div>
              </div>

              <!-- Sınav Detayları -->
              <div class="space-y-3 mb-4">
                <div class="text-sm text-espresso/60">
                  <strong>Ders:</strong> {{ studentService.selectedExam()?.subject }}
                </div>
                <div class="text-sm text-espresso/60">
                  <strong>Tarih:</strong> {{ formatTurkishDate(studentService.selectedExam()?.date || '') }}
                </div>
                <div class="text-sm text-espresso/60">
                  <strong>Sınav Türü:</strong> {{ studentService.selectedExam()?.type }}
                </div>
              </div>

              <!-- Detaylı Soru Analizi -->
              <div class="mt-4">
                <h5 class="text-sm font-semibold text-espresso mb-3">Soru Analizleri</h5>
                <div class="space-y-4 max-h-48 overflow-y-auto">
                  <div *ngFor="let question of getExamQuestions(); let i = index" class="border border-borderGray rounded-lg p-3 bg-gray-50">
                    <!-- Soru Başlığı ve Puan -->
                    <div class="flex justify-between items-center mb-2">
                      <div class="text-sm font-semibold text-espresso">Soru {{ question.soru_no }}</div>
                      <div class="text-xs font-medium" [ngClass]="{
                        'text-green-600': question.cevap.cevap_puan > 0,
                        'text-red-600': question.cevap.cevap_puan === 0
                      }">
                        {{ question.cevap.cevap_puan }}/{{ question.soru_puan }} puan
                      </div>
                    </div>
                    
                    <!-- Soru Metni -->
                    <div class="text-xs text-espresso mb-2 p-2 bg-white rounded border-l-4 border-blue-500">
                      <strong>Soru:</strong> {{ question.soru_metni }}
                    </div>
                    
                    <!-- Öğrenci Cevabı -->
                    <div class="text-xs text-espresso/80 mb-2 p-2 bg-white rounded">
                      <strong>Cevap:</strong> 
                      <span class="ml-1 font-medium">{{ question.cevap.cevap_metni || 'Cevap verilmemiş' }}</span>
                    </div>
                    
                    <!-- Analiz Bölümü -->
                    <div class="space-y-1">
                      <!-- Pozitif Analiz -->
                      <div *ngIf="question.analiz.pozitif && question.analiz.pozitif.trim()" 
                           class="text-xs text-green-800 bg-green-100 p-2 rounded border border-green-200">
                        <div class="flex items-start">
                          <span class="text-green-600 mr-1">✓</span>
                          <div>
                            <strong class="text-green-700">Pozitif:</strong>
                            <div class="mt-1">{{ question.analiz.pozitif }}</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Negatif Analiz -->
                      <div *ngIf="question.analiz.negatif && question.analiz.negatif.trim()" 
                           class="text-xs text-red-800 bg-red-100 p-2 rounded border border-red-200">
                        <div class="flex items-start">
                          <span class="text-red-600 mr-1">⚠</span>
                          <div>
                            <strong class="text-red-700">Negatif:</strong>
                            <div class="mt-1">{{ question.analiz.negatif }}</div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Analiz Yoksa -->
                      <div *ngIf="!question.analiz.pozitif && !question.analiz.negatif" 
                           class="text-xs text-gray-600 bg-gray-100 p-2 rounded">
                        <div class="flex items-center">
                          <span class="text-gray-500 mr-1">ℹ</span>
                          <span>Analiz bulunmuyor.</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Soru Yoksa -->
                  <div *ngIf="getExamQuestions().length === 0" 
                       class="text-center text-gray-500 py-4">
                    <div class="text-xs">Soru detayları bulunamadı.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    </div>

    <!-- Sınıf Metrikleri - Sınav seçildiğinde aşağıda görünür -->
    <div *ngIf="studentService.selectedExam()" class="mt-4 p-4 bg-gray-50 rounded-lg border border-borderGray">
      <h4 class="text-base font-semibold text-espresso mb-4">Sınıf Metrikleri</h4>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Ortalama Puan -->
        <div class="text-center p-4 bg-white rounded-lg border border-borderGray">
          <div class="text-2xl font-bold text-espresso">{{ studentService.selectedExam()?.averageScore }}</div>
          <div class="text-sm text-espresso/60">Ortalama Puan</div>
        </div>
        
        <!-- Kopya İhtimali -->
        <div class="text-center p-4 bg-white rounded-lg border border-borderGray">
          <div class="text-2xl font-bold" [ngClass]="{
            'text-green-600': (studentService.selectedExam()?.copyProb || 0) < 15,
            'text-yellow-600': (studentService.selectedExam()?.copyProb || 0) >= 15 && (studentService.selectedExam()?.copyProb || 0) < 40,
            'text-red-600': (studentService.selectedExam()?.copyProb || 0) >= 40
          }">%{{ studentService.selectedExam()?.copyProb }}</div>
          <div class="text-sm text-espresso/60">Kopya İhtimali</div>
        </div>
        
        <!-- Toplam Soru -->
        <div class="text-center p-4 bg-white rounded-lg border border-borderGray">
          <div class="text-2xl font-bold text-espresso">{{ studentService.selectedExam()?.totalQuestions }}</div>
          <div class="text-sm text-espresso/60">Toplam Soru</div>
        </div>
      </div>
      
      <!-- Kopya Analizi (eğer varsa) -->
      <div *ngIf="studentService.selectedExam()?.copyText" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="text-sm text-red-600 font-medium mb-2">⚠️ Kopya Analizi</div>
        <div class="text-sm text-red-700 whitespace-pre-line break-words overflow-wrap-anywhere max-h-32 overflow-y-auto">{{ studentService.selectedExam()?.copyText }}</div>
      </div>
    </div>
  </div>
</div>
